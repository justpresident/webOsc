<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Oscillators</title>
<!-- <script src="jquery&#45;3.6.0.min.js"></script> -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<style>
    .oscillator {
        border-radius: 5px;
        border: 2px solid teal;
        padding: 20px;
        display: inline-block;
    }
    .selected {
        background: yellow;
    }
    .oscState {
        display: block;
        border-radius: 5px;
        background: green;
    }
    .oscState.muted {
        background: darkred;
    }

    #oscillators {
        margin: 0px;
        margin-bottom: 10px;
        padding: 0px;
        display: inline-block;
    }

    #controls_help {
        display: inline-block;
        border-radius: 5px;
        border: 3px solid black;
        background: lightgrey;
    }
    #controls_help ul {
        display: inline-block;
        padding: 5px;
        margin: 0px;
    }
    #controls_help li {
        border-radius: 5px;
        border: 3px solid black;
        display: inline-block;
        padding: 5px;
        margin: 2px;
        float: left;
    }
    #controls_help li:first-child {
        border: none;
    }
    .pressed {
        background: olive;
    }
</style>
</head>
<body>
<div id="oscillators">
    <span class="oscillator">
        Frequency: <span class="frequency"></span>
        <span class="oscState">&nbsp;</span>
    </span>
</div>
<br/>
<div id="controls_help">
    <ul>
        <li>Start/Stop:</li>
        <li id="spaceBtn">Space</li>
    </ul>
    <br/>
    <ul>
        <li>Add Oscillator:</li>
        <li id="nBtn">N</li>
    </ul>
    <br/>
    <ul>
        <li>Select:</li>
        <li id="leftBtn">&larr;</li>
        <li id="rightBtn">&rarr;</li>
    </ul>
    <br/>
    <ul>
        <li>Volume Up:</li>
        <li id="qBtn">Q</li>
        <li id="wBtn">W</li>
        <li id="eBtn">E</li>
    </ul>
    <br/>
    <ul>
        <li>Volume Down:</li>
        <li id="aBtn">A</li>
        <li id="sBtn">S</li>
        <li id="dBtn">D</li>
    </ul>
</div>
<script type="text/javascript">
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const grossTune = 5;
    const mediumTune = 0.5;
    const fineTune = 0.05;
    const keys = [
        {key: "q", direction: "up",   tune: grossTune },
        {key: "a", direction: "down", tune: grossTune },
        {key: "w", direction: "up",   tune: mediumTune},
        {key: "s", direction: "down", tune: mediumTune},
        {key: "e", direction: "up",   tune: fineTune  },
        {key: "d", direction: "down", tune: fineTune  }
    ];

    var oscillators = [];
    var oscIndex = -1;
    var direction = "";
    var speed = 1;

    class SlowStartNode {
        constructor(audioContext) {
            this.node = audioCtx.createScriptProcessor(256, 1, 1);
            this.prevSample = 0.0;
            this.enabled = false;
            this.enabledFor = 0;
            this.fixingUp = false;
            this.fixingDown = false;
            this.node.onaudioprocess = function(audioProcessingEvent) {
                var inputBuffer = audioProcessingEvent.inputBuffer;
                var outputBuffer = audioProcessingEvent.outputBuffer;
                for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
                    var inputData = inputBuffer.getChannelData(channel);
                    var outputData = outputBuffer.getChannelData(channel);
                    var diffVal = 0;
                    for (var i = 0; i < inputBuffer.length; i++) {
                        // samples values are from -1 to 1
                        diffVal = this.prevSample - inputData[i];
                        this.fixingDown = (diffVal > 0.002);
                        this.fixingUp = (diffVal < -0.002);
                        if (this.enabled && this.fixingDown) {
                            outputData[i] = this.prevSample - 0.0015;
                        } else if (this.enabled && this.fixingUp) {
                            outputData[i] = this.prevSample + 0.0015;
                        } else {
                            outputData[i] = inputData[i];
                        }
                        if (this.enabled) {
                            this.enabledFor++;
                            this.enabled = (this.enabledFor < 400);
                        } else {
                            this.enabledFor = 0;
                        }
                        this.prevSample = outputData[i];
                    }
                }
            }
        }
    }

    class Oscillator {
        constructor(audioContext) {
            this.node = audioContext.createOscillator();
            this.gainNode = audioContext.createGain();
            this.slowStartNode = new SlowStartNode(audioContext);
            this.node.connect(this.gainNode);
            // this.gainNode.connect(audioContext.destination);
            this.gainNode.connect(this.slowStartNode.node);
            this.slowStartNode.node.connect(audioContext.destination);

            this.volume = 0.8

            this.node.frequency.value = 42;
            this.node.type = "sine";
            this.gainNode.gain.value = 0;
            this.muted = true;


            this.node.start();
        }
        muteToggle() {
            this.slowStartNode.node.enabled = true;
            if (this.muted) {
                this.gainNode.gain.value = this.volume;
            } else {
                this.gainNode.gain.value = 0;
            }
            this.muted = !this.muted;
        }
    }
    
    function manualLoop() {
        setTimeout(function() {
            manualLoop();         
            if (direction == "up"){
                oscillators[oscIndex].node.frequency.value += speed;
            }      
            if (direction == "down"){
                oscillators[oscIndex].node.frequency.value -= speed;
            }
            updateUI();
        }, 40)
    };

    function updateUI() {
        while ($(".oscillator").length < oscillators.length) {
            var newOsc = $(".oscillator").last().clone(true);
            newOsc.appendTo("#oscillators");
        }

        var uiOscillators = $(".oscillator");
        for (let i = 0; i < oscillators.length; i++) {
            var osc = uiOscillators.eq(i);
            osc.toggleClass("selected", (oscIndex == i))
            osc.children(".oscState").toggleClass("muted", oscillators[i].muted);
            osc.children(".frequency").html(oscillators[i].node.frequency.value.toFixed(2))
        }
    }

    $(document).ready(function() {
        oscillators.push(new Oscillator(audioCtx));
        oscIndex = 0;
        updateUI();
        manualLoop();
    }); 


    function btnId(key) {
        if (key == " ") {
            return "#spaceBtn";
        } else if (key == "ArrowLeft") {
            return "#leftBtn";
        } else if (key == "ArrowRight") {
            return "#rightBtn";
        } else {
            return "#" + key + "Btn";
        }
    };

    document.addEventListener('keydown', function(event) {
        if (event.key == " ") { // space bar
            oscillators[oscIndex].muteToggle();
            updateUI();
        } else if (event.key == "n") {
            oscillators.push(new Oscillator(audioCtx));
            oscIndex++;
 
            updateUI();
        } else if (event.key == "ArrowLeft") {
            oscIndex--;
            if (oscIndex < 0) {
                oscIndex = oscillators.length - 1;
            }
            updateUI();
        } else if (event.key == "ArrowRight") {
            oscIndex++;
            if (oscIndex >= oscillators.length) {
                oscIndex = 0;
            }
            updateUI();
        }
        for (var i = keys.length - 1; i >= 0; i--) {
            if(event.key == keys[i].key) {
                direction = keys[i].direction;
                speed = keys[i].tune; 
            } 
        }
        var buttonId = btnId(event.key)
        $(buttonId).addClass("pressed");
    });

    document.addEventListener('keyup', function(event) {
        $(btnId(event.key)).removeClass("pressed");
        direction = "";
    });    
</script>
</body>
</html>

